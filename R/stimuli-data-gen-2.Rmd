---
title: 'Stimuli data generation #2'
author: "Abhraneel Sarma"
date: "10/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(modelr)
library(tidybayes)
library(gamlss.dist)

theme_set( theme_light() ) +
  theme_update(
    panel.border = element_blank(),
    panel.grid.major = element_line(colour = "#666666", size = 0.1),
    panel.grid.minor = element_line(colour = "#666666", size = 0.1),
    panel.background = element_rect(fill = "transparent",colour = NA),
    plot.background = element_rect(fill = "transparent",colour = NA),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.text.y = element_text( size = 24 ),
    axis.title.y = element_text( size = 27 )
  )
```

## Study design
We manipulate the probability of the alternate hypothesis being true $P(H_1 = True) = 1 - p_{null}$, at consistent intervals between (0.5 and 1). We incentivise participants based on this probability.

- if $P(H_1 = True) = 0.5$, $Payoff_{TP} = Payoff_{FP} = Payoff_{TN} = Payoff_{FN}$
- if $P(H_1 = True) = 0.9$, $Payoff_{FP} = - 9 \times Payoff_{TP}$, $Payoff_{FN} = -1/9 \times Payoff_{TN}$ (_Note: we need to figure out the relationship between $Payoff_{TP}$ and $Payoff_{FN}$_)

For each value of $p_{null}$, we show participants k graphs with 10 data points in each graph. These graphs show the profits of 10 randomly sampled stores from a region with n stores. We ask them if, based on this sample, the stores are meeting a designated profit margin.

## Stimuli
We are using the following stimuli to test:

- scatterplot / bar chart / raw data (with mean point estimate?)
- mean point estimate with 95% confidence intervals
- gradient plot
- hypothetical outcome plots
- quantile dot plots
- cumulative distribution function
- cumulative distribution function + probability density function
- ensemble plots (overlay of low opacity bootstrapped means)


### Study Design

In our (initial pilot) study, we use a between subjects design where each participant will see a combination of different incentives and visualizations. Each participant will see 3 blocks of 30 trials each. Each block will consist of 10 trials for each of the three effect sizes. We also specify the number of regions, the prior probability of the number of stores being profitable in each trial (0.5); we do not vary these two values.

```{r setup_vars}
# we will load the data instead
set.seed(7841)
sample_size = 20
n_trials = 10
n_stores = 200
n_regions = 10
baseline = 0
p_h1_levels = 0.5 # c(seq(2, 8))
# effect_sizes = c(0.2, 0.5, 0.8) We use mean and SD pairs instead
mu_sd <- list(list(mu = 0.7, sd = 3.5), list(mu = 1.5, sd = 3), list(mu = 2, sd = 2.5))
```


### Simulating the data

- different mean and sd combinations such that the effect size is consistent
- different effect sizes (so that we can control for effect size)

First, we will simulate the data for the entire population. We create a data frame which contains all possible combinations of trials (indexed 1 to 10), and mean and standard deviation pairs. We then use a binomial distribution to simulate the mean for each of the 10 regions that will be presented to participants in a trial. Taking the value for each region as the mean of a normal distribution, we simulate the profits for the entire population (n = 20). We then randomly sample 20 stores from the population.

```{r eval = FALSE}
data.sim <- crossing( 
    trial = seq(1:n_trials),
    baseline = baseline,
    p_h1 = p_h1_levels,
    mu_sd_pairs = mu_sd
  ) %>%
  mutate(
    mu = map_dbl(mu_sd_pairs, ~ .x[[1]]),
    sd = map_dbl(mu_sd_pairs, ~ .x[[2]]),
    effect_size = mu / sd
  ) %>%
  mutate(
    mu = map2(p_h1, mu, ~ (rbinom(n_regions, 1, .x) * .y)),
    trial = 1:nrow(.)
  ) %>%
  unnest( cols = c(mu) ) %>%
  mutate( 
    region_idx = rep(1:n_regions, n_trials * length(means) * length(effect_sizes)),
    data = map2(mu, sd, ~ rnorm(n_stores, .x, .y))
  )

data.sample <- data.sim %>%
  mutate(
    profit = map(data, ~sample(., sample_size)),
    idx = seq(1:nrow(.)),
    region = map_chr(idx, function(.x) {
      set.seed((.x))
      paste0(sample(LETTERS, 4), collapse = "")
    }),
    store_idx = list(rep(1:sample_size))
  )

# save(data.sample, data.sim, file = "../data/simulated_data.RData")
```

```{r, sample}
load("../data/simulated_data.RData")
nu = sample_size - 1
```

### Bootstrapping to get sampling distributions

We bootstrap to obtain the sampling distributions for the means of each region in each trial. We also calculate limits to get reasonable values for the ends of the axes.

```{r, bootstrap_mean}
bootstrap_mean <- function(x, n = 5000) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map_dbl(iter, function(.x){
    set.seed(.x)
    mean(sample(x, length(x), replace = TRUE))
  }) 
}

data.sim.boot = data.sample %>%
  dplyr::select( -data ) %>%
  mutate( boot.mean = map(profit, bootstrap_mean))
```


```{r}
limits = data.sim.boot %>%
  unnest( cols = c(boot.mean)) %>%
  summarise(min = floor(min(boot.mean)), max = ceiling(max(boot.mean))) %>%
  gather() %>%
  magrittr::extract2("value")
```

### Adjusting for multiple comparisons

<TBD>
We then calculate what would be correct estimates for 

```{r}
data.sample %>%
  mutate(
    is_profit = ifelse( mu > 0, TRUE, FALSE)
  ) %>%
  dplyr::select(-c(mu_sd_pairs, baseline, p_h1, effect_size, data, profit, idx, region, store_idx)) %>%
  write.csv(file = "../data/true_effects.csv", row.names = FALSE)
```

## Visualizations

### 1.1. Scatterplot of raw data with jitter

```{r, scatterplot, fig.width = 10, fig.height = 4, warning = FALSE}
data.example <- data.sim.boot %>%
  filter( trial == 2, region_idx == 3 )
```

Below, we generate these plots and save it as images to be used in the pilot study.

```{r, scatterplot_save, fig.width = 3, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sample %>%  
        unnest( cols = c(profit, store_idx) ) %>%
        filter( trial == j & region_idx == i ) %>%
        ggplot(aes(x = NA, y = profit)) + 
        geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
        geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
        scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
        theme(legend.position = "none") +
        ylab( "profit" )
      
      ggsave(filename = paste0('../plots/raw-data/profits-t', j,'-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, plot = p, device = "jpeg") 
  }
}
```

### 2. Mean point estimate with error bars showing the 95% intervals for the data
This is not used

```{r, mean_ci, fig.width = 10, fig.height = 4, warning = FALSE}
data.sample %>%
  mean_qi(profit, .width = c(.95)) %>%
  select( - store_idx ) %>%
  filter( trial == 2  ) %>%
  ggplot(aes(x = NA, y = profit)) + 
  geom_pointinterval() +
  geom_point(aes(x = NA, y = profit), size = 4) +
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 )
```

### 3. Bootstrapped ensembles

```{r, fig.width = 10, fig.height = 4}
data.sim.boot %>%
  filter(trial == 1) %>%
  mutate( .value = map(boot.mean, ~sample(.x, 50))) %>%
  unnest( .value ) %>%
  ggplot(aes(x = NA, y = .value)) +
  geom_point( position = position_jitter(width = 0.2), alpha = 0.5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  facet_wrap( . ~ region, ncol = 5 )
  #ggtitle( "Mean profit for a product in 10 different regions" )
```

### 4. Bootstrapped means with 95% CI

```{r}
data.sample %>%
  filter( trial == 3 & region_idx == 1 ) %>%
  mutate( 
    mean = map_dbl(profit, mean),
    se = map_dbl(profit, ~sd(.x)/sqrt(length(.x))),
    .lower = qTF(0.025, mean, se, nu = nu),
    .upper = qTF(0.975, mean, se, nu = nu)
  ) %>%
  ggplot() + 
  geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) ) +
  xlim(-3, 3)
```


```{r, plot-mean-ci, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sample %>%
      filter( trial == j & region_idx == i ) %>%
      mutate( 
        mean = map_dbl(profit, mean),
        se = map_dbl(profit, ~sd(.x)/sqrt(length(.x))),
        .lower = qTF(0.025, mean, se, nu = nu),
        .upper = qTF(0.975, mean, se, nu = nu)
      ) %>%
      ggplot(aes(x = NA, y = mean)) + 
      geom_pointinterval(point_size = 5, interval_size = 12) +
      geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) ) +
      ylab( "profit" )
    
    ggsave(filename = paste0('../plots/ci/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
```


### 4.1 Confidence Interval plots to be shown as an example of the task

```{r}
data.sample %>%
  filter( trial == 3 & region_idx == 1 ) %>%
  rename( sample = profit, population = data) %>%
  mutate( 
    pop_mean = map_dbl(population, mean),
    mean = map_dbl(sample, mean),
    se = map_dbl(sample, ~sd(.x)/sqrt(length(.x))),
    .lower = qTF(0.025, mean, se, nu = nu),
    .upper = qTF(0.975, mean, se, nu = nu)
  ) %>%
  ggplot() + 
  geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
  geom_point(aes(x = -0.5, y = pop_mean), color = "#C44232", size = 5) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) ) +
  xlim(-3, 3)
```

```{r, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  p <- data.sample %>%
    filter(trial == 3 & region_idx == i) %>%
    rename(sample = profit, population = data) %>%
    mutate( 
      pop_mean = map_dbl(population, mean),
      mean = map_dbl(sample, mean),
      se = map_dbl(sample, ~sd(.x)/sqrt(length(.x))),
      .lower = qTF(0.025, mean, se, nu = nu),
      .upper = qTF(0.975, mean, se, nu = nu)
    ) %>%
    ggplot() + 
    geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
    geom_point(aes(x = -0.5, y = pop_mean), color = "#C44232", size = 5) +
    geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
    scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
    scale_color_manual( values=c("#C44232", "#333333")) +
    theme(legend.position = "none") +
    ylab( "profit" ) +
    xlim(-3, 3)

  ggsave(filename = paste0('../plots/example/profits-sol-t0-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
}
```

```{r, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  p <- data.sample %>%
    filter(trial == 3 & region_idx == i) %>%
    rename(sample = profit, population = data) %>%
    mutate( 
      mean = map_dbl(sample, mean),
      se = map_dbl(sample, ~sd(.x)/sqrt(length(.x))),
      .lower = qTF(0.025, mean, se, nu = nu),
      .upper = qTF(0.975, mean, se, nu = nu)
    ) %>%
    ggplot(aes(x = NA, y = mean), fill = "#333333") + 
    geom_pointinterval(position = position_dodge(width = 0.2), size = 16) +
    geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
    scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
    theme(legend.position = "none") +
    ylab( "profit" )

  ggsave(filename = paste0('../plots/example/profits-t0-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
}
```


```{r, plot-mean-ci, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  for(j in 1:(n_trials * length(effect_sizes) * length(means))) {
    p <- data.sample %>%
      filter( trial == j & region_idx == i ) %>%
      mutate( 
        mean = map_dbl(profit, mean),
        se = map_dbl(profit, ~sd(.x)/sqrt(length(.x))),
        .lower = qTF(0.025, mean, se, nu = nu),
        .upper = qTF(0.975, mean, se, nu = nu)
      ) %>%
      ggplot(aes(x = NA, y = mean)) + 
      geom_pointinterval(point_size = 5, interval_size = 12) +
      geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) ) +
      ylab( "mean profit and 95% confidence interval" )
    
    ggsave(filename = paste0('../plots/ci/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
```


### 5. Gradient plots

```{r, fig.width = 10, fig.height = 4}
data.sim.boot %>%
  filter(trial == 2 & region_idx == 3) %>%
  unnest( cols = c(boot.mean) ) %>%
  group_by(region) %>%
  ggplot(aes(y = boot.mean, x = NA)) +
  stat_gradientinterval(fill = "blue", show_interval = TRUE) +
  scale_alpha_continuous(range = c(0, 1)) +
  facet_wrap( ~ region_idx, ncol = 5 ) +
  labs( alpha = "density" ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  ylim( limits )
```


### 6. Hypothetical outcome plots

```{r, hops, fig.width = 10, fig.height = 4}
n_samples = 50

data.sim.boot %>%
  filter(trial == 1 & p_h1 == 0.5) %>%
  unnest( cols = c(boot.mean) ) %>%
  group_by(region) %>%
  sample_n( n_samples ) %>%
  mutate( mean.index = 1:n_samples) %>%
  ggplot(aes(x = NA, y = boot.mean)) +
  geom_point() +
  facet_wrap( ~ region, ncol = 5 )  +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  gganimate::transition_manual( mean.index )
```



### 7. Probability Density Function

```{r, plot-mean-density, fig.width = 3.5, fig.height = 6}
data.sim.boot  %>%
  filter(trial == 2 & region_idx == 3) %>%
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = NA, y = boot.mean) ) +
  stat_halfeye(point_size = 5, interval_size = 8) +
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
  ylab( "probability distribution of mean profit" )
```

```{r, pred-density, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sim.boot %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.mean) ) %>%
      ggplot( aes(x = NA, y = boot.mean) ) +
      stat_halfeye(point_size = 5, interval_size = 8) +
      geom_hline( yintercept = 0, size = 1, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
      ylab( "profit" )

    ggsave(filename = paste0('../plots/halfeye/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
```


### 8. Quantile dot plots

```{r, plot-mean-density, fig.width = 10, fig.height = 4}
p <- data.sim.boot  %>%
  filter(trial == 2 & region_idx == 3) %>%
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = NA, y = boot.mean) )  +
  stat_dots(position = "dodge", quantiles = 50) +
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  coord_cartesian( ylim = c(-2, 4))

pdf(file = "../figures/dots.pdf", useDingbats = FALSE, width = 5, height = 8)
p
dev.off()
```


```{r, scatterplot, fig.width = 6, fig.height = 4, warning = FALSE}
p1 <- data.example %>% 
  unnest( cols = c(profit, store_idx) ) %>%
  ggplot(aes(x = NA, y = profit)) + 
  geom_jitter( width = 0.2, alpha = 0.7, size = 3 ) + 
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  ylim(limits) +
  ylab( "profit for 20 stores from a region" )
  
p2 <- data.example %>% 
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = NA, y = boot.mean) ) +
  stat_halfeye(point_size = 5, interval_size = 8) +
  geom_hline( yintercept = 0, size = 1, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
  ylab( "probability distribution of mean profit" )


pdf(file = "../figures/pdf_calc_plot.pdf", useDingbats = FALSE, width = 8, height = 10)
cowplot::plot_grid(p1, p2, rel_widths = c(2, 1))
dev.off()
```
