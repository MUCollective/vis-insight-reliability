---
title: "Introductory plots for Visualization insights project"
date: "3/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(modelr)
library(tidybayes)
# library(gamlss.dist)

theme_set( theme_light() ) +
  theme_update(
    panel.border = element_blank(),
    panel.grid.major = element_line(colour = "#666666", size = 0.1),
    panel.grid.minor = element_line(colour = "#666666", size = 0.1),
    panel.background = element_rect(fill = "transparent",colour = NA),
    plot.background = element_rect(fill = "transparent",colour = NA),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.text.y = element_text( size = 24 ),
    axis.title.y = element_text( size = 27 )
  )
```

```{r setup_vars}
# we will load the data instead
set.seed(9175)
sample_size = 20
n_trials = 10
n_stores = 20
n_region = c(12, 8)
baseline = 0
p_h1_levels = 0.5 # c(seq(2, 8))
# effect_sizes = c(0.2, 0.5, 0.8) We use mean and SD pairs instead
mu_sd <- list(list(mu = 1.2, sd = 3), list(mu = 1.5, sd = 2.5), list(mu = 1.6, sd = 2))

d <- crossing( 
    trial = seq(1:n_trials),
    p_h1 = p_h1_levels,
    mu_sd_pairs = mu_sd
  ) %>%
  mutate(
    trial = 1:nrow(.),
    mean = map_dbl(mu_sd_pairs, ~ .x[[1]]),
    sd = map_dbl(mu_sd_pairs, ~ .x[[2]]),
    effect_size = mean / sd
  ) %>%
  select(-mu_sd_pairs)
```

## Data

We have already created the data for the stimuli. We shall just load that into this document

```{r, sample}
#load("../data/simulated_data.RData")
data.sim.12reg <- readRDS(file = "../data/simulated_data_12regions.rds")
data.sim.8reg <- readRDS(file = "../data/simulated_data_8regions.rds")
nu = sample_size - 1
```

### Bootstrapping to get sampling distributions

We bootstrap to obtain the sampling distributions for the means of each region in each trial.

```{r, bootstrap_mean}
bootstrap_mean <- function(x, n = 5000) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map_dbl(iter, function(.x){
    set.seed(.x)
    mean(sample(x, length(x), replace = TRUE))
  }) 
}

data.sim.boot.12reg = data.sim.12reg %>%
  mutate(boot.mean = map(data, bootstrap_mean)) %>%
  select(-c(mean, mu, sd))

 data.sim.boot.8reg = data.sim.8reg %>%
  mutate( boot.mean = map(data, bootstrap_mean)) %>%
  select(-c(mean, mu, sd))
```

We also calculate limits to get reasonable values for the ends of the axes.

```{r}
limits = rbind(data.sim.8reg, data.sim.12reg) %>%
  mutate( 
    mean = map_dbl(data, ~ mean(.x)),
    se = map_dbl(data, ~sd(.x)/sqrt(length(.x))),
    .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
    .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
  ) %>%
  summarise(min = floor(min(.lower)) - 1, max = ceiling(max(.upper)) + 1) %>%
  gather() %>%
  magrittr::extract2("value")
```

## Introductory plots

In the following secion we create the figures which we use to introduce participants to the different visualization types used in this study.

```{r}
data.example <- data.sim.boot.12reg %>%
  filter( trial == 2, region_idx == 3 )

limits = c(-4, 4)
```

### Probability density function

```{r, pdf, fig.width = 6, fig.height = 4, warning = FALSE}
p1 <- data.example %>% 
  unnest( cols = c(data) ) %>%
  ggplot(aes(x = NA, y = data)) + 
  geom_jitter( width = 0.2, alpha = 0.7, size = 3 ) + 
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  ylim(limits) +
  ylab( "profit for 20 stores from a region" )
  
p2 <- data.example %>% 
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = NA, y = boot.mean) ) +
  stat_halfeye(point_size = 5, interval_size = 8) +
  geom_hline( yintercept = 0, size = 1, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
  ylab( "probability distribution of mean profit" )


pdf(file = "../figures/R-pdf_calc_plot.pdf", useDingbats = FALSE, width = 8, height = 10)
cowplot::plot_grid(p1, p2, rel_widths = c(2, 1))
dev.off()
```

### Quantile dot plots

```{r, dotplots, fig.width = 6, fig.height = 4, warning = FALSE}
p1 <- data.example %>% 
  unnest( cols = c(data) ) %>%
  ggplot(aes(x = NA, y = data)) + 
  geom_jitter( width = 0.2, alpha = 0.7, size = 3 ) + 
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  ylim(limits) +
  ylab( "profit for 20 stores from a region" )
  
p2 <- data.example %>% 
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = 0, y = boot.mean) )  +
  stat_dots(position = "dodge", quantiles = 20, binwidth = 0.4, fill = "#4682B4", color = "#ffffff") +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_x_continuous(limits = c(-0.5, 3), breaks = 0) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) ) +
  ylab( "profit" )


pdf(file = "../figures/R-dotplot_calc_plot.pdf", useDingbats = FALSE, width = 8, height = 10)
cowplot::plot_grid(p1, p2, rel_widths = c(2, 1))
dev.off()
```


### Hypothetica outcome plots #1 (quantiles)

```{r, hops, fig.width = 6, fig.height = 4, warning = FALSE}
p2 <- data.example %>% 
  mutate( quantiles = map(boot.mean, ~ quantile(., prob = seq(1/50, 1 - 1/50, by = 1/50))) ) %>%
  unnest( cols = c(quantiles) ) %>%
  group_by(region_idx) %>%
  sample_n(nrow(.)) %>%
  mutate( frame = 1:nrow(.)) %>%
  ggplot(aes(x = NA, y = quantiles)) +
  geom_point(size = 5) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
  theme(axis.title.y = element_blank()) +
  gganimate::transition_manual( frame ) 
  
gganimate::animate(p2, nframes = 50, fps = 2.5, width = 210, height = 576, res = 72)
gganimate::anim_save(filename = paste0('../figures/R-hops-1.gif'))
```


### Hypothetica outcome plots #2 (samples of raw data)

```{r, hops, fig.width = 6, fig.height = 4, warning = FALSE}
bootstrap_samples <- function(x, n = 50) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map(iter, function(.x){
    set.seed(.x)
    sample(x, length(x), replace = TRUE)
  })
}

p2 <- data.example %>%
  mutate( boot.samples = map(data, bootstrap_samples)) %>%
  unnest( cols = c(boot.samples) ) %>%
  mutate( frame = 1:nrow(.)) %>%
  unnest( cols = c(boot.samples) ) %>%
  group_by(region_idx) %>%
  ggplot(aes(x = NA, y = boot.samples)) +
  geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]], limits[[2]], by = 2) )  +
  ylab( "profit" ) +
  gganimate::transition_manual( frame )
  
gganimate::animate(p2, nframes = 50, fps = 2.5, width = 210, height = 576, res = 72)
gganimate::anim_save(filename = paste0('../figures/R-hops-2.gif'))
```
