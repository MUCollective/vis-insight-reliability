---
title: 'Stimuli data generation #2'
author: "Abhraneel Sarma"
date: "10/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(modelr)
library(tidybayes)
```

## Study design
We manipulate the probability of the alternate hypothesis being true $P(H_1 = True) = 1 - p_{null}$, at consistent intervals between (0.5 and 1). We incentivise participants based on this probability.

- if $P(H_1 = True) = 0.5$, $Payoff_{TP} = Payoff_{FP} = Payoff_{TN} = Payoff_{FN}$
- if $P(H_1 = True) = 0.9$, $Payoff_{FP} = - 9 \times Payoff_{TP}$, $Payoff_{FN} = -1/9 \times Payoff_{TN}$ (_Note: we need to figure out the relationship between $Payoff_{TP}$ and $Payoff_{FN}$_)

For each value of $p_{null}$, we show participants k graphs with 10 data points in each graph. These graphs show the profits of 10 randomly sampled stores from a region with n stores. We ask them if, based on this sample, the stores are meeting a designated profit margin.

## Stimuli
We are using the following stimuli to test:

- scatterplot / bar chart / raw data (with mean point estimate?)
- mean point estimate with 95% confidence intervals
- gradient plot
- hypothetical outcome plots
- quantile dot plots
- cumulative distribution function
- cumulative distribution function + probability density function
- ensemble plots (overlay of low opacity bootstrapped means)


## Data generation

```{r}
set.seed(7841)
k = 10
sample_size = 10
n_stores = 100
n_regions = 10
baseline = 0

p_h1 = c(seq(5, 9))
sd = seq(2, 3, 5)

data.sim <- crossing( 
    trial = seq(1:k),
    baseline = baseline,
    p_h1 = p_h1,
    sd = sd
  ) %>%
  mutate( 
    mu = map( p_h1, ~ c(rep(1, .x), rep(0, n_regions - .x)) ),
    mu = map(mu, ~ sample(.x, size = n_regions) ),
    p_h1 = p_h1 / 10
  ) %>%
  unnest( cols = c(mu) ) %>%
  mutate( 
    region_idx = rep(1:10, 50),
    data = map2(mu, sd, ~ rnorm(n_stores, .x, .y))
  )
```

```{r, fig.width = 12, fig.height = 8}
data.sample <- data.sim %>%
  mutate(
    profit = map(data, ~sample(., sample_size)),
    idx = seq(1:nrow(.)),
    region = map_chr(idx, function(.x) {
      set.seed((.x))
      paste0(sample(LETTERS, 4), collapse = "")
    }),
    store_idx = list(rep(1:k))
  )
```

## Visualizations

### 1. Bar chart (raw data points with mean point estimate)

```{r, raw_data, fig.width = 10, fig.height = 4}
data.sample %>%
  unnest( cols = c(profit, store_idx) ) %>%
  filter( trial == 1 & p_h1 == 0.5 ) %>%
  ggplot(aes(x = store_idx, y = profit)) + 
  geom_col() + 
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_x_continuous( breaks = seq(0, 10, by = 2))
```


### 1.1. Scatterplot of raw data with jitter

```{r, scatterplot, fig.width = 10, fig.height = 4, warning = FALSE}
for(i in 1:n_regions) {
  p <- data.sample %>%  
    unnest( cols = c(profit, store_idx) ) %>%
    filter( trial == 1 & p_h1 == 0.5 & region_idx == i ) %>%
    ggplot(aes(x = NA, y = profit)) + 
    geom_jitter(width = 0.2, alpha = 0.5, colour = "red") + 
    # facet_wrap( ~ region, ncol = 5 ) +
    geom_hline( yintercept = 0, color = "red", alpha = 0.5 )
  
  ggsave(filename = paste0('../plots/raw-data/profits-', i, '.png'), height = 6, width = 9, units = "in", dpi = 150, plot = p, device = "png")
}
```

### 2. Mean point estimate with 95% CIs, along with raw data

```{r, mean_ci, fig.width = 10, fig.height = 4, warning = FALSE}
data.interval <- data.sample %>%
  mean_qi(profit, .width = c(.66, .95)) %>%
  select( - store_idx ) %>%
  filter( trial == 1 & p_h1 == 0.5 )

data.sample %>%  
  unnest( cols = c(profit, store_idx) ) %>%
  filter( trial == 1 & p_h1 == 0.5 ) %>%
  ggplot(aes(x = NA, y = profit)) + 
  geom_jitter(width = 0.2, alpha = 0.5, colour = "red") + 
  geom_pointinterval(data = data.interval) +
  # geom_errorbar( data = data.interval, aes(ymin = .lower, ymax = .upper, x = NA), width = 0.15) +
  geom_point( data = data.interval, aes(x = NA, y = profit), size = 4) +
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 )
```

```{r, bootstrap_mean}
bootstrap_mean <- function(x, n = 5000) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map_dbl(iter, function(.x){
    set.seed(.x)
    mean(sample(x, length(x), replace = TRUE))
  }) 
}

data.sim.boot = data.sample %>%
  select( -data ) %>%
  mutate( boot.mean = map(profit, bootstrap_mean))
```

### 3. Bootstrapped ensembles

```{r, fig.width = 10, fig.height = 4}
data.sim.boot %>%
  filter(trial == 1 & p_h1 == 0.5) %>%
  mutate( .value = map(boot.mean, ~sample(.x, 50))) %>%
  unnest( .value ) %>%
  ggplot(aes(x = NA, y = .value)) +
  geom_point( position = position_jitter(width = 0.2), alpha = 0.5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  facet_wrap( . ~ region, ncol = 5 )
  #ggtitle( "Mean profit for a product in 10 different regions" )
```

### 4. Bootstrapped means with 95% CI

```{r, plot-mean-ci, fig.width = 10, fig.height = 4, warning = FALSE}
data.sim.boot %>%
  filter(trial == 1 & p_h1 == 0.5) %>%
  unnest( cols = c(boot.mean) ) %>%
  group_by(region) %>%
  mean_qi(boot.mean, .width = c(.66, .95)) %>%
  ggplot(aes(y = boot.mean, x = NA)) +
  geom_pointinterval() +
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) #+
  #ggtitle( "Bootstrap mean profit (for the past 25 weeks) from a sample of 25 stores in 4 different regions" )
```


### 5. Gradient plots

```{r, fig.width = 10, fig.height = 4}
data.sim.boot %>%
  filter(trial == 1 & p_h1 == 0.5) %>%
  unnest( cols = c(boot.mean) ) %>%
  group_by(region) %>%
  ggplot(aes(y = boot.mean, x = NA)) +
  stat_gradientinterval(fill = "blue", show_interval = TRUE) +
  scale_alpha_continuous(range = c(0, 1)) +
  facet_wrap( ~ region, ncol = 5 ) +
  labs( alpha = "density" ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" )
```


### 6. Hypothetical outcome plots

```{r, hops, fig.width = 10, fig.height = 4}
n_samples = 50

data.sim.boot %>%
  filter(trial == 1 & p_h1 == 0.5) %>%
  unnest( cols = c(boot.mean) ) %>%
  group_by(region) %>%
  sample_n( n_samples ) %>%
  mutate( mean.index = 1:n_samples) %>%
  ggplot(aes(x = NA, y = boot.mean)) +
  geom_point() +
  facet_wrap( ~ region, ncol = 5 )  +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  gganimate::transition_manual( mean.index )
```



### 7. Probability Density Function

```{r, plot-mean-density, fig.width = 10, fig.height = 4}
data.sim.boot  %>%
  filter(trial == 1 & p_h1 == 0.5) %>%
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = NA, y = boot.mean) ) +
  stat_halfeye() +
  facet_wrap( ~ region, ncol = 5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" )
```
