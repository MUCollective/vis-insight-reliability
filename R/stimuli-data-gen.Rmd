---
title: "Stimulus Data"
author: "Abhraneel Sarma"
date: "7/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(rstanarm)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(modelr)
library(tidybayes)
library(rstanarm)

theme_set( theme_gray() )
```


## Stimuli

We are using the following stimuli to test:

- scatterplot / raw data
- mean point estimate
- mean point estimate with 95% confidence intervals
- gradient plot
- hypothetical outcome plots
- quantile dot plots
- cumulative distribution function
- cumulative distribution function + probability density function
- ensemble plots (overlay of low opacity bootstrapped means)


## Data

### Quantitative, Nominal

We will assume the following data generation process for this distribution

$$
sales_{i, j} \sim \mathrm{Normal( \mu_{i, j}, \sigma)} \\
u_{i, j} = \alpha_0 + \alpha_{product[i]} + \alpha_{region[j]} \\
\alpha_0 \sim \mathrm{Normal(3, 1)} \\
\alpha_{product[i]} \sim \mathrm{Normal(0, \sigma_p)} \\
\alpha_{region[j]} \sim \mathrm{Normal(0, \sigma_r)} \\
\sigma, \sigma_p, \sigma_r \sim \mathrm{exponential(1)}
$$

```{r, data-gen-env}
ntrials = 10
nproducts = 5
nregions = 4
sd = 0.5
N = nproducts * nregions * ntrials
Ni = 25

#runs = 20
#eff_seed <- sample(1:2^15, runs)
#data.sim <- list()
```


```{r, data-generation}
set.seed(13735)
data.sim <- crossing(
    trial = seq(1:ntrials),
    region.idx = seq(1:nregions),
    product = factor( LETTERS[1:nproducts] ),
    a_bar = 4,
    sigma = sd * 4,
    sigma_group = sd
  ) %>%
  mutate( 
    region = map2_chr(trial, region.idx, function(.x, .y) {
      set.seed((.x*10 + .y))
      paste0(sample(LETTERS, 3), collapse = "")
    }) 
  ) %>%
  mutate(
    mu_region = rep(rep(rnorm(nregions, 0, sigma_group), each = nproducts), ntrials),
    mu_product = rep(rnorm(nproducts, 0, 1), nregions * ntrials),
    true_mu = rnorm(N, a_bar, sigma_group) + mu_product + mu_region,
    sd = sigma / sqrt(Ni),
    profit = map2( true_mu, sigma, ~rnorm(Ni, .x, .y))
  )
```

### 1. Raw data

```{r, gen-data-raw, fig.width = 12, fig.height = 5}
for(i in 1:ntrials) {
    p <- data.sim %>%
        filter( trial == i) %>%
        unnest( profit ) %>%
        ggplot() +
        geom_point( aes(x = product, y = profit), position = position_jitter(width = 0.1), alpha = 0.5 ) +
        facet_wrap( ~region ) +
        coord_cartesian( ylim = c(-4, 12)) +
        ggtitle( "Profit (for each of the past 25 weeks) for products A - E in regions K - N" )
    
    ggsave(filename = paste0('../plots/raw-data/profits-', i, '.png'), height = 9, width = 16, units = "in", dpi = 72, plot = p, device = "png")
}
```


```{r, plot-data-raw, fig.width = 12, fig.height = 5}
p
```

### 2. Mean

```{r, plot-mean-bar, fig.width = 12, fig.height = 5}
data.sim %>%
  filter( trial == 1 ) %>%
  mutate( .value = map_dbl(profit, mean)) %>%
  ggplot(aes(x = product, y = .value)) +
  geom_col() +
  facet_grid( . ~ region ) +
  coord_cartesian( ylim = c(0, 5)) +
  ggtitle( "Mean profit (over the past 50 weeks) for products A - E in regions K - N" )
```


```{r, bootstrap_mean}
bootstrap_mean <- function(x, n = 5000) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map_dbl(iter, function(.x){
    set.seed(.x)
    mean(sample(x, length(x), replace = TRUE))
  }) 
}

data.sim.boot = data.sim %>%
  mutate( boot.mean = map(profit, bootstrap_mean))
```

### 3. Ensemble sample of means

```{r, plot-mean-ensemble, fig.width = 12, fig.height = 5}
data.sim.boot %>%
  filter(trial == 1) %>%
  mutate( .value = map(boot.mean, ~sample(.x, 50))) %>%
  unnest( .value ) %>%
  ggplot(aes(x = product, y = .value)) +
  geom_point( position = position_jitter(width = 0.2), alpha = 0.5 ) +
  coord_cartesian( ylim = c(0, 6) ) +
  facet_grid( . ~ region ) +
  ggtitle( "Mean profit (over the past 50 weeks) for products A - E in regions K - N" )
```

### 4. Mean + 95% confidence intervals

```{r, gen-mean-ci, fig.width = 12, fig.height = 5}
for(i in 1:ntrials) {
    p <- data.sim.boot %>%
        filter(trial == i) %>%
        unnest( boot.mean ) %>%
        group_by(product, region) %>%
        mean_qi(boot.mean, .width = .95) %>%
        ggplot(aes(y = boot.mean, x = product)) +
        geom_pointinterval() +
        coord_cartesian( ylim = c(0, 6)) +
        facet_wrap( ~ region, ncol = 4 ) +
        ggtitle( "Mean profit (over the past 50 weeks) for products A - E in regions K - N" )
    
    ggsave(filename = paste0('../plots/mean-ci/profits-', i, '.png'), height = 9, width = 16, units = "in", dpi = 72, plot = p, device = "png")
}
```

```{r, plot-mean-ci, fig.width = 12, fig.height = 5}
p
```


### 5. Gradient plots

```{r, fig.width = 7, fig.height = 3}
data.sim.boot %>%
  unnest( boot.mean ) %>%
  group_by(product, region) %>%
  ggplot(aes(y = boot.mean, x = product)) +
  stat_gradientinterval(fill = "blue", show_interval = TRUE) +
  scale_alpha_continuous(range = c(0, 1)) +
  coord_cartesian( ylim = c(0, 4)) +
  facet_wrap( ~ region, ncol = 4 ) +
  labs( alpha = "density" ) +
  ggtitle( "Mean profit (over the past 50 weeks) for products A - E in regions K - N" )
```

### 6. PDF

```{r, plot-mean-density, fig.width = 7, fig.height = 3}
data.sim %>%
  ggplot( aes(x = product, dist = "norm", arg1 = true_mu, arg2 = sd) ) +
  stat_dist_halfeye() +
  coord_cartesian( ylim = c(0, 4)) +
  facet_wrap( ~ region, ncol = 4 ) +
  ggtitle( "Mean profit (over the past 50 weeks) for products A - E in regions K - N" )
```

### 7. Hypothetical outcome plots

```{r, hops, fig.width = 12, fig.height = 3}
n_samples = 20

data.sim.boot %>%
  unnest( boot.mean ) %>%
  group_by(product, region) %>%
  sample_n( n_samples ) %>%
  mutate( mean.index = 1:n_samples) %>%
  ggplot(aes(x = boot.mean, y = region)) +
  geom_col() +
  facet_wrap( ~ region ) +
  gganimate::transition_manual( mean.index )
```

### 8. Quantile dotplot


```{r, quantile_dotplot, fig.width = 7, fig.height = 6}
data.sim.boot %>%
  unnest( boot.mean ) %>%
  group_by(product, region) %>%
  do(tibble(mean = quantile(.$boot.mean, ppoints(20)))) %>%
  ggplot(aes(x = mean)) +
  geom_dotplot(binwidth = .1) +
  facet_wrap( c("region", "product"), strip.position = "left", ncol = 2 ) +
  facet_title_left_horizontal() +
  scale_y_continuous(breaks = NULL) +
  coord_cartesian( ylim = c(0, 4)) +
  ggtitle( "Mean profit (over the past 50 weeks) for products A - E in regions K - N" )
```

### 9. Cumulative distribution function

```{r, cdf, fig.width = 12, fig.height = 6}
n_samples.cdf = 100

endpoints = d %>%
  select(index, diff, region) %>%
  mutate(mean = 4, cdf = 1)

d %>%
  unnest(boot.mean)  %>%
  group_by(index, diff, region) %>%
  do(tibble(mean = quantile(.$boot.mean, ppoints(n_samples.cdf)))) %>%
  mutate( cdf = (1:n_samples.cdf)/n_samples.cdf ) %>%
  ungroup() %>%
  rbind(endpoints) %>%
  filter( diff == -0.125) %>%
  ggplot(aes(x = mean, y = cdf)) +
  geom_area() +
  facet_grid( region ~ index ) +
  coord_cartesian(xlim = c(1.5, 2.5), ylim = c(0, 1.2)) +
  scale_y_continuous( breaks = seq(0, 1.5, by = 0.5) )
```


------------------ Ignore ------------------
## Scenario 2: Correlation

Multivariate gaussian https://stat.ethz.ch/R-manual/R-devel/library/MASS/html/mvrnorm.html
1. positive correlation 
2. negative correlation
3. no correlation

```{r, message = FALSE}
variance <- 4
sigmas <- list(
    matrix(c(1, 0, 0, 1), 2, 2),
    matrix(c(1, 0.3, 0.3, 1), 2, 2),
    matrix(c(1, -0.3, -0.3, 1), 2, 2)
  )

set.seed(100)
mvt_df = crossing(
  size = c(50, 100, 200),
  sigma = sigmas
) %>%
  mutate(
    mean = list(c(3, 1)),
    j = seq(1:nrow(.)),
    sigma = map(sigma, ~ .x * variance),
    mvt_data = pmap(list(size, mean, sigma), ~MASS::mvrnorm(..1, ..2, ..3) %>%
                  as_tibble(.name_repair = "unique") %>%
                  rename( "x" = '...1', "y" = "...2" ) %>%
                  mutate( index = seq(1:nrow(.))))
  )
```

### Set of possible insights

1. There is no correlation between x and y (TRUE for 1, 4, 7)
2. There is a small positive correlation between x and y (TRUE for 2, 5, 8 )
3. There is a small negative correlation between x and y  (TRUE for 3, 6, 9 )


### Baseline

```{r, message = FALSE, fig.width = 12, fig.height = 4}
n = 100

mvt_df.disaggregated = mvt_df %>%
  unnest(mvt_data) %>%
  select(index, everything()) 

mvt_df.disaggregated %>%
  filter(size == n) %>%
  ggplot() + 
  geom_point(aes(x, y)) +
  facet_wrap( ~ j ) +
  coord_cartesian( xlim = c(-5, 10), ylim = c(-3, 7))
```

```{r, results = "hide", message = FALSE}
mvt_df = mvt_df %>%
  mutate(fit = map(mvt_data, ~ stan_glm(y ~ x, data = .x)))
```


### 2. Mean regression line

```{r}
#newdata = data.frame(x = seq(0, 8, by = 0.2))
mvt.draws = mvt_df %>%
  mutate(
    # newdata = map(mvt_data, ~ data_grid(., x = seq_range(.$x, n = 21))),
    newdata = list(tibble(x = seq(-5, 9, by = 0.2))),
    means = map2(newdata, fit, ~ add_fitted_draws(.x, .y))
  )
```


```{r, fig.width = 12, fig.height = 4}
mvt.draws  %>%
  filter( size == n ) %>%
  unnest(means, .preserve = c(size, sigma, mean, mvt_data)) %>%
  ggplot() +
  stat_lineribbon(aes(x = x, y = .value), .width = 0) +
  scale_fill_brewer() +
  coord_cartesian( xlim = c(-5, 10), ylim = c(-4, 7)) +
  facet_wrap( ~ j )
```

```{r, fig.width = 12, fig.height = 4}
mvt.draws  %>%
  filter( size == n ) %>%
  unnest(means, .preserve = c(size, sigma, mean, mvt_data)) %>%
  ggplot() +
  stat_lineribbon(aes(x = x, y = .value), .width = 0) +
  geom_point(data = filter(mvt_df.disaggregated, size == n), aes(x, y), alpha = 0.4) +
  scale_fill_brewer() +
  coord_cartesian( xlim = c(-5, 10), ylim = c(-4, 7)) +
  facet_wrap( ~ j )
```


```{r, fig.width = 12, fig.height = 4}
mvt.draws  %>%
  filter( size == 50 ) %>%
  unnest(means, .preserve = c(size, sigma, mean, mvt_data)) %>%
  ggplot() +
  stat_lineribbon(aes(x = x, y = .value)) +
  scale_fill_brewer() +
  coord_cartesian( xlim = c(-5, 10), ylim = c(-4, 7)) +
  facet_wrap( ~ j )
```


```{r, fig.width = 12, fig.height = 4}
mvt_ensembles = mvt_df %>%
  filter( size == 50 ) %>%
  mutate(
    # newdata = map(mvt_data, ~ data_grid(., x = seq_range(.$x, n = 21))),
    newdata = list(tibble(x = seq(-5, 9, by = 0.2))),
    means = map2(newdata, fit, ~ add_fitted_draws(.x, .y, n = 100))
  ) %>%
  unnest(means, .preserve = c(size, sigma, mean, mvt_data))

mvt_ensembles %>%
  ggplot() +
  geom_line(aes(x = x, y = .value, group = .draw), alpha = 0.1, color = "#08519C") +
  #geom_point() +
  coord_cartesian( xlim = c(-5, 10), ylim = c(-4, 7)) +
  facet_wrap( ~ j)
```

```{r, fig.width = 12, fig.height = 4}
p <- mvt_ensembles %>%
  filter(j == 1) %>%  
  ggplot() +
  geom_line(aes(x = x, y = .value, group = .draw), color = "#08519C") +
  coord_cartesian( xlim = c(-5, 10), ylim = c(-4, 7)) +
  #geom_point() +
  gganimate::transition_manual( .draw )

gganimate::animate(p, fps = 3)
```

