---
title: 'Stimuli data generation'
author: "Abhraneel Sarma"
date: "10/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(modelr)
library(tidybayes)
# library(gamlss.dist)
theme_set( theme_light() ) +
  theme_update(
    panel.border = element_blank(),
    panel.grid.major = element_line(colour = "#666666", size = 0.1),
    panel.grid.minor = element_line(colour = "#666666", size = 0.1),
    panel.background = element_rect(fill = "transparent",colour = NA),
    plot.background = element_rect(fill = "transparent",colour = NA),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.text.y = element_text( size = 24 ),
    axis.title.y = element_text( size = 27 )
  )
```

## Study design
We manipulate the probability of the alternate hypothesis being true $P(H_1 = True) = 1 - p_{null}$, at consistent intervals between (0.5 and 1). We incentivise participants based on this probability.

- if $P(H_1 = True) = 0.5$, $Payoff_{TP} = Payoff_{FP} = Payoff_{TN} = Payoff_{FN}$
- if $P(H_1 = True) = 0.9$, $Payoff_{FP} = - 9 \times Payoff_{TP}$, $Payoff_{FN} = -1/9 \times Payoff_{TN}$ (_Note: we need to figure out the relationship between $Payoff_{TP}$ and $Payoff_{FN}$_)

For each value of $p_{null}$, we show participants k graphs with 10 data points in each graph. These graphs show the profits of 10 randomly sampled stores from a region with n stores. We ask them if, based on this sample, the stores are meeting a designated profit margin.

## Stimuli
We are using the following stimuli to test:

- scatterplot / bar chart / raw data
- mean point estimate with 95% confidence intervals
- probability density plots
- hypothetical outcome plots of raw data
- hypothetical outcome plots of quantiles of sampling distribution
- <del>quantile dot plots</del>
- <del>gradient plot</del>
- <del>cumulative distribution function</del>
- <del>cumulative distribution function + probability density function</del>
- <del>ensemble plots (overlay of low opacity bootstrapped means)</del>


### Study Design

In our (initial pilot) study, we use a between subjects design where each participant will see a combination of different incentives and visualizations. Each participant will see 3 blocks of 30 trials each. Each block will consist of 10 trials for each of the three effect sizes. We also specify the number of regions, the prior probability of the number of stores being profitable in each trial (0.5); we do not vary these two values.

```{r setup_vars}
# we will load the data instead
set.seed(9175)
sample_size = 20
n_trials = 10
n_stores = 20
n_region = c(12, 8)
baseline = 0
p_h1_levels = 0.5 # c(seq(2, 8))
# effect_sizes = c(0.2, 0.5, 0.8) We use mean and SD pairs instead
mu_sd <- list(list(mu = 0.9, sd = 3), list(mu = 1.2, sd = 2.67), list(mu = 1.5, sd = 2.5))
d <- crossing( 
    trial = seq(1:n_trials),
    p_h1 = p_h1_levels,
    mu_sd_pairs = mu_sd
  ) %>%
  mutate(
    trial = 1:nrow(.),
    mean = map_dbl(mu_sd_pairs, ~ .x[[1]]),
    sd = map_dbl(mu_sd_pairs, ~ .x[[2]]),
    effect_size = mean / sd
  ) %>%
  select(-mu_sd_pairs)
```


### Simulating the data

- different mean and sd combinations such that the effect size is consistent
- different effect sizes (so that we can control for effect size)

First, we will simulate the data for the entire population. We create a data frame which contains all possible combinations of trials (indexed 1 to 10), and mean and standard deviation pairs. We then use a binomial distribution to simulate the mean for each of the 10 regions that will be presented to participants in a trial. Taking the value for each region as the mean of a normal distribution, we simulate the profits for the entire population (n = 20). We then randomly sample 20 stores from the population.

```{r, eval = FALSE}
set.seed(9175)
data.sim <- d %>%
  mutate(
    mu = map(p_h1, ~ (rbinom(n_region[[1]], 1, .x)))
  )
data.sim.12reg <- data.sim %>%
  mutate(region_idx = map(mu, ~ seq(1:n_region[[1]]))) %>%
  unnest(cols = c(mu, region_idx)) %>%
  mutate( 
    mu = mean * mu,
    data = map2(mu, sd, ~ rnorm(n_stores, .x, .y))
  )
data.sim.8reg <- data.sim %>%
  mutate(
    mu = map(mu, ~ sample(., size = 8)),
    region_idx = map(mu, ~ seq(1:n_region[[2]]))
  ) %>%
  unnest(cols = c(mu, region_idx)) %>%
  mutate( 
    mu = mean * mu,
    data = map2(mu, sd, ~ rnorm(n_stores, .x, .y))
  )
#saveRDS(data.sim.12reg, file = "../data/simulated_data_12regions.rds")
#saveRDS(data.sim.8reg, file = "../data/simulated_data_8regions.rds")
```


```{r, sample}
#load("../data/simulated_data.RData")
data.sim.12reg <- readRDS(file = "../data/simulated_data_12regions.rds")
data.sim.8reg <- readRDS(file = "../data/simulated_data_8regions.rds")
nu = sample_size - 1
```

## Decision making using different strategies
Below, we compute the FDR if analyst accounted for multiple comparisons

```{r}
df.bh <- bind_rows(list("8" = data.sim.8reg, "12" = data.sim.12reg), .id = "nregions") %>%
  select(-c(region_idx, effect_size, population, p_h1)) %>%
  mutate(nregions = as.numeric(nregions), delta = mean/sd) %>%
  mutate(
    p_raw = map_dbl(data, ~ t.test(.x, alternative = "greater")$p.value),
    p_bh = p.adjust(p_raw, "BH")
  ) %>%
  select(-data) %>%
  pivot_longer(starts_with("p_"), names_to = "method", values_to = "p") %>%
  mutate(reject = p < alpha, true = mu == 0)

write.csv(df.bh, "../data/final-study-bh.csv", row.names = FALSE)
```



### Bootstrapping to get sampling distributions

We bootstrap to obtain the sampling distributions for the means of each region in each trial.

```{r, bootstrap_mean}
bootstrap_mean <- function(x, n = 5000) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map_dbl(iter, function(.x){
    set.seed(.x)
    mean(sample(x, length(x), replace = TRUE))
  }) 
}
data.sim.boot.12reg = data.sim.12reg %>%
  mutate(boot.mean = map(data, bootstrap_mean)) %>%
  select(-c(mean, mu, sd))
 data.sim.boot.8reg = data.sim.8reg %>%
  mutate( boot.mean = map(data, bootstrap_mean)) %>%
  select(-c(mean, mu, sd))
```

We also calculate limits to get reasonable values for the ends of the axes.

```{r}
limits = rbind(data.sim.8reg, data.sim.12reg) %>%
  mutate( 
    mean = map_dbl(data, ~ mean(.x)),
    se = map_dbl(data, ~sd(.x)/sqrt(length(.x))),
    .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
    .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
  ) %>%
  summarise(min = floor(min(.lower)) - 1, max = ceiling(max(.upper)) + 1) %>%
  gather() %>%
  magrittr::extract2("value")
```

We store the results (whether a region is profitable of or not based on the data-generating process) in a CSV file, so that we can evaluate a participants' responses as they take the trials.

```{r, eval = FALSE}
rbind(mutate(data.sim.12reg, nregions = n_region[[1]]), mutate(data.sim.8reg, nregions = n_region[[2]])) %>%
  mutate(is_profit = ifelse(mu > 0, TRUE, FALSE)) %>%
  dplyr::select(-c(data)) %>%
  write.csv(file = "../data/true_effects.csv", row.names = FALSE)
```

## Visualizations

### 1.1. Scatterplot of raw data with jitter

In our study, we show participants a sample of 20 stores from each region (which contains 200 stores). The `raw data` condition simply shows the points, with the user having to infer the mean and uncertainty from the plot, and make a decision on whether the region is profitable or not.

```{r, scatterplot, warning = FALSE}
dat1 <- data.sim.12reg %>%
  filter( trial == 3 & region_idx == 1 ) %>% unnest(data) %>% 
  magrittr::extract2("data")
```

```{r}
dat2 <- c(dat1, -7.6, -8.1, -7.3, -8.2, -6.1)

data.sim.12reg[data.sim.12reg$trial == 3 & data.sim.12reg$region_idx == 1,]$data <- list(dat2)

p <- data.sim.12reg %>%  
  unnest( cols = c(data) ) %>%
  filter( trial == 3 & region_idx == 1 ) %>%
  ggplot(aes(x = NA, y = data)) + 
  geom_jitter( width = 0.05, alpha = 0.7, alpha = 0.5) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = c(-9, 5), breaks = seq(-8, 5, by = 2) )  +
  theme(legend.position = "none") +
  ylab( "profit" )

p <- data.sim.12reg %>%
  filter( trial == 3 & region_idx == 1 ) %>%  
  mutate( 
    mean = map_dbl(data, ~ mean(.x)),
    se = map_dbl(data, ~sd(.x)/sqrt(length(.x))),
    .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
    .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
  ) %>%
  ggplot() + 
  geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = c(-9, 5), breaks = seq(-8, 5, by = 2) ) +
  xlim(-3, 3)
```


```{r}
p <- data.sim.12reg %>%
  filter(trial == 3 & region_idx == 1) %>%
  mutate(boot.mean = map(data, bootstrap_mean)) %>%
  select(-c(mean, mu, sd)) %>%
  mutate( quantiles = map(boot.mean, ~ quantile(., prob = seq(1/50, 1 - 1/50, by = 1/50))) ) %>%
  unnest( cols = c(quantiles) ) %>%
  group_by(region_idx) %>%
  sample_n(nrow(.)) %>%
  mutate( frame = 1:nrow(.)) %>%
  ggplot(aes(x = NA, y = quantiles)) +
  geom_point(size = 15, color = "#fafafa") +
  geom_hline( yintercept = 0, alpha = 0.8, color = "red", size = 2 ) +
  scale_y_continuous( limits = c(-9, 5), breaks = seq(-8, 5, by = 2) ) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  gganimate::transition_manual( frame )

gganimate::animate(p, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
gganimate::anim_save(filename = paste0('~/Desktop/comres/07-hops-m.gif'))
```

```{r}
p <- data.sim.12reg %>%
  mutate( boot.samples = map(data, bootstrap_samples)) %>%
  select(-c(p_h1, mu, sd, effect_size, mean, data)) %>%
  filter(trial == 3 & region_idx == 1) %>%
  unnest( cols = c(boot.samples) ) %>%
  mutate( frame = 1:nrow(.)) %>%
  unnest( cols = c(boot.samples) ) %>%
  group_by(region_idx) %>%
  ggplot(aes(x = NA, y = boot.samples)) +
  geom_jitter( width = 0.2, alpha = 0.7, size = 10, color = "#fafafa") +
  geom_hline( yintercept = 0, size = 4, alpha = 0.8, color = "red" ) +
  scale_y_continuous( limits = c(-9, 5), breaks = seq(-8, 5, by = 2) ) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  gganimate::transition_manual( frame )

gganimate::animate(p, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
gganimate::anim_save(filename = paste0('~/Desktop/comres/08-hops-b.gif'))
```


```{r}
pdf(file = "~/Desktop/comres/02-ci-plot.pdf", useDingbats = FALSE, width = 8, height = 10)
p
dev.off()
```



```{r, scatterplot, warning = FALSE}
data.sim.12reg %>%  
  unnest( cols = c(data) ) %>%
  filter( trial == 3 & region_idx == 2 ) %>%
  ggplot(aes(x = NA, y = data)) + 
  geom_jitter( width = 0.05, alpha = 0.7, alpha = 0.5) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = c(-9, 5), breaks = seq(-8, 5, by = 2) )  +
  theme(legend.position = "none") +
  ylab( "profit" )
```

Below, we generate these plots and save it as images to be used in the pilot study.

```{r, scatterplot_save, fig.width = 3, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.12 <- data.sim.12reg %>%
        filter( trial == j & region_idx == i ) %>%  
        unnest( cols = c(data) ) %>%
        ggplot(aes(x = NA, y = data)) + 
        geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
        geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
        scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
        theme(legend.position = "none") +
        ylab( "profit" )
      
      ggsave(filename = paste0('../plots/raw-data/12-regions/profits-t', j,'-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, plot = p.12, device = "jpeg")
  }
}
for(i in 1:n_region[[2]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.8 <- data.sim.8reg %>%
        filter( trial == j & region_idx == i ) %>%  
        unnest( cols = c(data) ) %>%
        ggplot(aes(x = NA, y = data)) + 
        geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
        geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
        scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
        theme(legend.position = "none") +
        ylab( "profit" )
      
      ggsave(filename = paste0('../plots/raw-data/8-regions/profits-t', j,'-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, plot = p.8, device = "jpeg") 
  }
}
```

### 2. Bootstrapped ensembles

We bootstrap the mean for the sample of 20 points, and plot the means. The bootsrapped means are roughly the same as the sampling distribution of the mean.

```{r, fig.width = 10, fig.height = 4}
data.sim.boot.12reg %>%
  filter(trial == 1) %>%
  mutate( .value = map(boot.mean, ~sample(.x, 50))) %>%
  unnest( .value ) %>%
  ggplot(aes(x = NA, y = .value)) +
  geom_point( position = position_jitter(width = 0.2), alpha = 0.5 ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  facet_wrap( . ~ region_idx, ncol = 4 )
  #ggtitle( "Mean profit for a product in 10 different regions" )
```

### 3. Bootstrapped means with 95% CI

This shows the mean point estimate and the 95% boostrapped confidence intervals for the data.

```{r}
data.sim.12reg %>%
  filter( trial == 3 & region_idx == 1 ) %>%
  mutate( 
    mean = map_dbl(data, ~ mean(.x)),
    se = map_dbl(data, ~sd(.x)/sqrt(length(.x))),
    .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
    .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
  ) %>%
  ggplot() + 
  geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = c(-5, 7), breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) ) +
  xlim(-3, 3)
```


```{r, plot-mean-ci, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.12 <- data.sim.12reg %>%
      filter( trial == j & region_idx == i ) %>%
      mutate( 
        mean = map_dbl(data, ~ mean(.x)),
        se = map_dbl(data, ~sd(.x)/sqrt(length(.x))),
        .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
        .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
      ) %>%
      ggplot(aes(x = NA, y = mean)) + 
      geom_pointinterval(point_size = 5, interval_size = 12) +
      geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) ) +
      ylab( "profit" )
      
      ggsave(filename = paste0('../plots/ci/12-regions/profits-t', j,'-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, plot = p.12, device = "jpeg")
  }
}
for(i in 1:n_region[[2]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.8 <- data.sim.8reg %>%
      filter( trial == j & region_idx == i ) %>%
      mutate( 
        mean = map_dbl(data, ~ mean(.x)),
        se = map_dbl(data, ~sd(.x)/sqrt(length(.x))),
        .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
        .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
      ) %>%
      ggplot(aes(x = NA, y = mean)) + 
      geom_pointinterval(point_size = 5, interval_size = 12) +
      geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) ) +
      ylab( "profit" )
      
      ggsave(filename = paste0('../plots/ci/8-regions/profits-t', j,'-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, plot = p.8, device = "jpeg") 
  }
}
```


#### 3.1 Confidence Interval plots to be shown as an example of the task

```{r}
data.sim.12reg %>%
  filter( trial == 5 & region_idx == 1 ) %>%
  rename( sample = data, population = mean) %>%
  mutate( 
    pop_mean = population,
    mean = map_dbl(sample, ~ mean(.x)),
    se = map_dbl(sample, ~sd(.x)/sqrt(length(.x))),
    .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
    .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
  ) %>%
  ggplot() + 
  geom_pointinterval(aes(x = 0, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
  #geom_point(aes(x = -0.5, y = pop_mean), color = "#C44232", size = 5) +
  geom_hline( yintercept = 0, color = "red", alpha = 0.5 ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) ) +
  xlim(-3, 3)
```

```{r, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  p <- data.sim.12reg %>%
    filter(trial == 5 & region_idx == i) %>%
    rename(sample = data, population = mean) %>%
    mutate( 
      pop_mean = mu,
      mean = map_dbl(sample, mean),
      se = map_dbl(sample, ~sd(.x)/sqrt(length(.x))),
      .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
      .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
    ) %>%
    ggplot() + 
    geom_pointinterval(aes(x = 0, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
    #geom_point(aes(x = -0.5, y = pop_mean), color = "#C44232", size = 5) +
    geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
    scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
    scale_color_manual( values=c("#C44232", "#333333")) +
    theme(legend.position = "none") +
    ylab( "profit" ) +
    xlim(-3, 3)
  ggsave(filename = paste0('../plots/example/profits-t0-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
}
```


#### 3.2 Attention check 

THe next two sections are the graphs used in the attention check questions.

```{r, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  p <- data.sim.12reg %>%
    filter(trial == 3 & region_idx == i) %>%
    rename(sample = data, population = mean) %>%
    mutate( 
      mean = limits[2] - 2 + runif(n()),
      se = runif(n()) * 0.1 + 0.1,
      .lower = gamlss.dist::qTF(0.025, mean, se, nu = nu),
      .upper = gamlss.dist::qTF(0.975, mean, se, nu = nu)
    ) %>%
    ggplot() + 
    geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
    # geom_point(aes(x = -0.5, y = pop_mean), color = "#C44232", size = 5) +
    geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
    scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
    scale_color_manual( values=c("#C44232", "#333333")) +
    theme(legend.position = "none") +
    ylab( "profit" ) +
    xlim(-3, 3)
  ggsave(filename = paste0('../plots/attention/profit-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
}
```


```{r, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_regions) {
  p <- data.sample %>%
    filter(trial == 3 & region_idx == i) %>%
    rename(sample = profit, population = data) %>%
    mutate( 
      pop_mean = limits[1] + 0.5,
      mean = limits[1] +0.5,
      se = 0.1,
      .lower = qTF(0.025, mean, se, nu = nu),
      .upper = qTF(0.975, mean, se, nu = nu)
    ) %>%
    ggplot() + 
    geom_pointinterval(aes(x = 0.5, y = mean), fill = "#333333", point_size = 5, interval_size = 12) +
    geom_point(aes(x = -0.5, y = pop_mean), color = "#C44232", size = 5) +
    geom_hline( yintercept = 0, size = 1, color = "red", alpha = 0.5 ) +
    scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
    scale_color_manual( values=c("#C44232", "#333333")) +
    theme(legend.position = "none") +
    ylab( "profit" ) +
    xlim(-3, 3)
  ggsave(filename = paste0('../plots/attention/noprofit-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
}
```

### 4. Probability Density Function

```{r, plot-mean-density}
data.sim.boot.12reg  %>%
  filter(trial == 2 & region_idx == 3) %>%
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = NA, y = boot.mean) ) +
  stat_halfeye(point_size = 5, interval_size = 8) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
  ylab( "profit" )
```

```{r, pred-density, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sim.boot.12reg %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.mean) ) %>%
      ggplot( aes(x = NA, y = boot.mean) ) +
      stat_halfeye(point_size = 5, interval_size = 8) +
      geom_hline( yintercept = 0, size = 1, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
      ylab( "profit" )
    ggsave(filename = paste0('../plots/halfeye/12-regions/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
for(i in 1:n_region[[2]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sim.boot.8reg %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.mean) ) %>%
      ggplot( aes(x = NA, y = boot.mean) ) +
      stat_halfeye(point_size = 5, interval_size = 8) +
      geom_hline( yintercept = 0, size = 1, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
      ylab( "profit" )
    ggsave(filename = paste0('../plots/halfeye/8-regions/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
```

### 5.1 Hypothetical outcome plots (quantiles)

```{r, hops, fig.width = 10, fig.height = 4}
p <- data.sim.boot.8reg %>%
  filter(trial == 3 & region_idx == 1) %>%
  mutate( quantiles = map(boot.mean, ~ quantile(., prob = seq(1/50, 1 - 1/50, by = 1/50))) ) %>%
  unnest( cols = c(quantiles) ) %>%
  group_by(region_idx) %>%
  sample_n(nrow(.)) %>%
  mutate( frame = 1:nrow(.)) %>%
  ggplot(aes(x = NA, y = quantiles)) +
  geom_point(size = 5) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
  ylab( "profit" ) +
  gganimate::transition_manual( frame )

gganimate::animate(p, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
```

```{r, pred-density, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.12 <- data.sim.boot.12reg %>%
      filter( trial == j & region_idx == i ) %>%
      mutate( quantiles = map(boot.mean, ~ quantile(., prob = seq(1/50, 1 - 1/50, by = 1/50))) ) %>%
      unnest( cols = c(quantiles) ) %>%
      group_by(region_idx) %>%
      sample_n(nrow(.)) %>%
      mutate( frame = 1:nrow(.)) %>%
      ggplot(aes(x = NA, y = quantiles)) +
      geom_point(size = 5) +
      geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
      ylab( "profit" ) +
      gganimate::transition_manual( frame )
      
      gganimate::animate(p.12, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
      gganimate::anim_save(filename = paste0('../plots/hops-1/12-regions/profits-t', j, '-p0.5-', i, '.gif'))
  }
}
for(i in 1:n_region[[2]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.8 <- data.sim.boot.8reg %>%
      filter( trial == j & region_idx == i ) %>%
      mutate( quantiles = map(boot.mean, ~ quantile(., prob = seq(1/50, 1 - 1/50, by = 1/50))) ) %>%
      unnest( cols = c(quantiles) ) %>%
      group_by(region_idx) %>%
      sample_n(nrow(.)) %>%
      mutate( frame = 1:nrow(.)) %>%
      ggplot(aes(x = NA, y = quantiles)) +
      geom_point(size = 5) +
      geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
      ylab( "profit" ) +
      gganimate::transition_manual( frame )
      
      gganimate::animate(p.8, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
      gganimate::anim_save(filename = paste0('../plots/hops-1/8-regions/profits-t', j, '-p0.5-', i, '.gif'))
  }
}
```

### 5.2 Hypothetical outcome plots (raw data)

```{r}
bootstrap_samples <- function(x, n = 50) {
  if (is_list(x)) x = flatten_dbl(x)
  iter = 1:n
  map(iter, function(.x){
    set.seed(.x)
    sample(x, length(x), replace = TRUE)
  })
}
p <- data.sim.12reg %>%
  mutate( boot.samples = map(data, bootstrap_samples)) %>%
  select(-c(p_h1, mu, sd, effect_size, mean, data)) %>%
  filter(trial == 3 & region_idx == 1) %>%
  unnest( cols = c(boot.samples) ) %>%
  mutate( frame = 1:nrow(.)) %>%
  unnest( cols = c(boot.samples) ) %>%
  group_by(region_idx) %>%
  ggplot(aes(x = NA, y = boot.samples)) +
  geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
  ylab( "profit" ) +
  gganimate::transition_manual( frame )
gganimate::animate(p, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
```

```{r, pred-density, fig.width = 10, fig.height = 4, eval = FALSE}
data.samples.boot = data.sim.12reg %>%
  mutate( boot.samples = map(data, bootstrap_samples)) %>%
  select(-c(p_h1, mu, sd, effect_size, mean, data))
for(i in 1:n_region[[1]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.12 <- data.samples.boot %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.samples) ) %>%
      mutate( frame = 1:nrow(.)) %>%
      unnest( cols = c(boot.samples) ) %>%
      group_by(region_idx) %>%
      ggplot(aes(x = NA, y = boot.samples)) +
      geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
      geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
      ylab( "profit" ) +
      gganimate::transition_manual( frame )
      
      gganimate::animate(p.12, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
      gganimate::anim_save(filename = paste0('../plots/hops-2/12-regions/profits-t', j, '-p0.5-', i, '.gif'))
  }
}
data.samples.boot = data.sim.8reg %>%
  mutate( boot.samples = map(data, bootstrap_samples)) %>%
  select(-c(p_h1, mu, sd, effect_size, mean, data))
for(i in 1:n_region[[2]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p.8 <- data.samples.boot %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.samples) ) %>%
      mutate( frame = 1:nrow(.)) %>%
      unnest( cols = c(boot.samples) ) %>%
      group_by(region_idx) %>%
      ggplot(aes(x = NA, y = boot.samples)) +
      geom_jitter( width = 0.2, alpha = 0.7, size = 5) +
      geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]] + 1, by = 2) )  +
      ylab( "profit" ) +
      gganimate::transition_manual( frame )
      
      gganimate::animate(p.8, nframes = 50, fps = 2.5, width = 360, height = 576, res = 72)
      gganimate::anim_save(filename = paste0('../plots/hops-2/8-regions/profits-t', j, '-p0.5-', i, '.gif'))
  }
}
```


### 6. Quantile dot plots


```{r, plot-mean-density}
data.sim.boot.12reg %>%
  filter(trial == 1 & region_idx == 2) %>%
  unnest( cols = c(boot.mean) ) %>%
  ggplot( aes(x = 0, y = boot.mean) )  +
  stat_dots(position = "dodge", quantiles = 20, binwidth = 0.4, fill = "#4682B4", color = "#ffffff") +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  scale_x_continuous(limits = c(-0.5, 3), breaks = 0) +
  scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]], by = 2) ) +
  ylab( "profit" )
```


```{r, dot-plots, fig.width = 10, fig.height = 4, eval = FALSE}
for(i in 1:n_region[[1]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sim.boot.12reg %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.mean) ) %>%
      ggplot( aes(x = 0, y = boot.mean) )  +
      stat_dots(position = "dodge", quantiles = 20, binwidth = 0.4, fill = "#4682B4", color = "#ffffff") +
      geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
      scale_x_continuous(limits = c(-0.5, 3), breaks = 0) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]], by = 2) ) +
      ylab( "profit" )
    ggsave(filename = paste0('../plots/dotplot/12-regions/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
for(i in 1:n_region[[2]]) {
  for(j in 1:(n_trials * length(mu_sd))) {
    p <- data.sim.boot.8reg %>%
      filter( trial == j & region_idx == i ) %>%
      unnest( cols = c(boot.mean) ) %>%
      ggplot( aes(x = 0, y = boot.mean) )  +
      stat_dots(position = "dodge", quantiles = 20, binwidth = 0.4, fill = "#4682B4", color = "#ffffff") +
      geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
      scale_x_continuous(limits = c(-0.5, 3), breaks = 0) +
      scale_y_continuous( limits = limits, breaks = seq(limits[[1]] + 1, limits[[2]], by = 2) ) +
      ylab( "profit" )
    ggsave(filename = paste0('../plots/dotplot/8-regions/profits-t', j, '-p0.5-', i, '.png'), height = 8, width = 5, units = "in", dpi = 72, type = "cairo-png", plot = p, device = "png")
  }
}
```

### 7. Gradient plots

```{r}
data.sim.boot %>%
  filter(trial == 2 & region_idx == 3) %>%
  unnest( cols = c(boot.mean) ) %>%
  group_by(region) %>%
  ggplot(aes(y = boot.mean, x = NA)) +
  stat_gradientinterval(fill = "blue", show_interval = TRUE) +
  scale_alpha_continuous(range = c(0, 1)) +
  facet_wrap( ~ region_idx, ncol = 5 ) +
  labs( alpha = "density" ) +
  geom_hline( yintercept = 0, alpha = 0.5, color = "red" ) +
  ylim( limits )
```

